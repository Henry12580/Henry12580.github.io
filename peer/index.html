<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>

<body>
  <div id="root">
    <video class="self" autoplay muted data-focused="false"></video>
    <video class="peer" autoplay data-focused></video>
  </div>
  <dialog id="dialog">
    <div>
      <span>您的id是 &nbsp; </span><span id="my-id"></span>
    </div>
    <div>
      <span>请输入对方id：</span><input id="peer-id" type="text">
    </div>
    <div class="flex-row buttons">
      <button id="copy-my-id">复制id到剪贴板</button>
      <button id="confirm-peer-id">确认</button>
      <button id="close-diag">关闭</button>
    </div>
  </dialog>
</body>

<style>
  * {
    margin: 0;
  }

  div#root {
    width: 100%;
  }

  .flex-row {
    display: flex;
    flex-direction: row;
  }

  .flex-row.buttons {
    justify-content: end;
  }

  button {
    margin: 5px;
  }

  @media (min-width: 1200px) {
    div#root {
      display: flex;
      align-items: start;
    }

    video[data-focused=false] {
      flex-grow: 1;
    }

    video[data-focused=true] {
      height: 100vh;
    }
  }

  video:hover {
    cursor: pointer;
  }

  @media (max-width: 1199px) {
    video {
      width: 100vw;
    }
  }
</style>

<script>
  let myId = "";
  let peerId = "";
  const peer = new Peer();
  const selfVideo = document.querySelector('video.self');
  const peerVideo = document.querySelector('video.peer');
  const myIdSpan = document.querySelector('#my-id');
  const dialog = document.querySelector('#dialog');
  const peerIdInput = document.querySelector('#peer-id');
  const copyMyIdButton = document.querySelector('#copy-my-id');
  const confirmPeerIdButton = document.querySelector('#confirm-peer-id');
  const closeDiagButton = document.querySelector('#close-diag');

  confirmPeerIdButton.addEventListener('click', event => {
    const peerId_new = peerIdInput.value;
    if (peerId !== peerId_new) {
      peerId = peerId_new;
      call();
    }
    dialog.close();
  });

  closeDiagButton.addEventListener('click', event => {
    dialog.close();
  });

  // dialog.addEventListener('close', )

  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState !== "visible") {
      await peerVideo.requestPictureInPicture();
    } else {
      document.exitPictureInPicture();
    }
  })

  copyMyIdButton.addEventListener('click', async event => {
    await navigator.clipboard.writeText(myIdSpan.innerHTML);
    alert('已复制到剪贴板！');
  })

  selfVideo.addEventListener('click', event => {
    event.preventDefault();
    selfVideo.dataset.focused = true;
    peerVideo.dataset.focused = false;
  });

  peerVideo.addEventListener('click', event => {
    event.preventDefault();
    peerVideo.dataset.focused = true;
    selfVideo.dataset.focused = false;
  });

  peer.on('open', id => {
    myId = id;
    myIdSpan.innerHTML = myId;
    dialog.showModal();
  });

  function call() {
    var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    getUserMedia({ video: true, audio: true }, function (stream) {
      selfVideo.srcObject = stream;

      if (peerId) {
        const call = peer.call(peerId, stream);
        call.on('stream', function (remoteStream) {
          peerVideo.srcObject = remoteStream;
        });
      }

      peer.on('call', function (call) {
        call.answer(stream);
        call.on('stream', function (remoteStream) {
          peerVideo.srcObject = remoteStream;
        })
      })
    }, function (err) {
      console.error('Failed to get local stream', err);
    });
  }

  call();

</script>

</html>